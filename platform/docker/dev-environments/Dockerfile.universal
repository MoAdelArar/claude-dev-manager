FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    git curl wget unzip zip \
    build-essential gcc g++ make cmake \
    python3 python3-pip python3-venv \
    sqlite3 libsqlite3-dev \
    libssl-dev libffi-dev \
    ca-certificates \
    jq tree vim nano \
    && rm -rf /var/lib/apt/lists/*

# Node.js 20 via NodeSource (needed for Claude Code and CDM)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

RUN npm install -g yarn pnpm typescript ts-node

# Claude Code — the AI coding agent
RUN npm install -g @anthropic-ai/claude-code

# Claude Dev Manager — 18-agent pipeline orchestrator
RUN npm install -g claude-dev-manager || true
# If CDM isn't on npm yet, it gets cloned at runtime from the repo

RUN pip3 install --no-cache-dir \
    pytest black flake8 mypy \
    requests flask django fastapi uvicorn

RUN curl -sSL https://go.dev/dl/go1.22.0.linux-amd64.tar.gz | tar -C /usr/local -xzf -
ENV PATH="/usr/local/go/bin:${PATH}"

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

WORKDIR /workspace

RUN git config --global init.defaultBranch main

# Pre-install CDM from GitHub if npm package not available
RUN git clone --depth 1 https://github.com/MoAdelArar/claude-dev-manager.git /opt/cdm && \
    cd /opt/cdm && npm install && npm run build && npm link 2>/dev/null || true

CMD ["sleep", "infinity"]
